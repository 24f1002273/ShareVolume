<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Share Volume for Loading...</title>
    <!-- Bootstrap CSS from CDN for basic styling -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background-color: #e9ecef;
            color: #343a40;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }
        .container {
            max-width: 800px;
            background-color: #ffffff;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        h1 {
            color: #0056b3;
            margin-bottom: 30px;
            font-size: 2.2em;
            font-weight: 700;
        }
        .section-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-top: 25px;
            margin-bottom: 15px;
            color: #007bff;
            border-bottom: 2px solid #007bff;
            padding-bottom: 8px;
            display: inline-block;
        }
        .value-item {
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        .value-item .label {
            font-weight: normal;
            color: #6c757d;
            margin-right: 5px;
        }
        .value-item span:not(.label) {
            font-weight: bold;
            color: #28a745; /* Success green */
        }
        .error-message {
            color: #dc3545; /* Danger red */
            font-weight: bold;
            margin-top: 20px;
            padding: 10px;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
        }
        .footer-links {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e2e6ea;
            font-size: 0.9em;
            color: #6c757d;
        }
        .footer-links a {
            color: #007bff;
            text-decoration: none;
            margin: 0 8px;
        }
        .footer-links a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="share-entity-name">Loading Entity Name...</h1>

        <p class="section-title">Common Stock Shares Outstanding (FY > 2020)</p>

        <div class="value-item">
            <span class="label">Highest Value:</span> <span id="share-max-value">Loading...</span> <span class="label">(Fiscal Year:</span> <span id="share-max-fy">Loading...</span><span class="label">)</span>
        </div>
        <div class="value-item">
            <span class="label">Lowest Value:</span> <span id="share-min-value">Loading...</span> <span class="label">(Fiscal Year:</span> <span id="share-min-fy">Loading...</span><span class="label">)</span>
        </div>

        <div id="error-display" class="error-message mt-3" style="display: none;"></div>
        
        <div class="footer-links">
            <p class="text-muted small mb-1">
                Data provided by U.S. Securities and Exchange Commission.
            </p>
            <p class="text-muted small">
                Try with a different CIK:
                <a href="?CIK=0001018724">Intel (0001018724)</a> |
                <a href="?CIK=0000320193">Apple (0000320193)</a> |
                <a href="?CIK=0000874761">AES Corporation (0000874761)</a>
            </p>
        </div>
    </div>

    <script>
        /**
         * Fetches and processes common stock shares outstanding data from the SEC API,
         * then updates the UI with the maximum and minimum values for fiscal years > 2020.
         *
         * @param {string} cik - The CIK (Central Index Key) of the company.
         */
        async function fetchAndDisplayData(cik) {
            const defaultCik = '0000874761'; // CIK for AES Corporation
            const isDefaultCik = (cik === defaultCik);
            const secBaseUrl = 'https://data.sec.gov/api/xbrl/companyconcept/';
            const endpoint = `/dei/EntityCommonStockSharesOutstanding.json`;
            
            // Per SEC guidance, a descriptive User-Agent is required for direct API access.
            // When using a proxy, the proxy typically handles its own User-Agent.
            const userAgent = 'ShareVolumeApp/1.0 MyCompany/MyProject (contact@example.com)';

            let url = `${secBaseUrl}CIK${cik}${endpoint}`;
            let fetchOptions = {};

            // If a CIK other than the default AES CIK is provided, use a public CORS proxy.
            // This bypasses CORS restrictions when fetching directly from client-side JavaScript.
            // In a production environment, a dedicated backend proxy is recommended.
            if (!isDefaultCik) {
                url = `https://corsproxy.io/?${encodeURIComponent(url)}`;
                // No need to set User-Agent for the proxy; the proxy makes the actual request to SEC.gov.
            } else {
                // For direct requests to SEC.gov, include the User-Agent.
                fetchOptions.headers = { 'User-Agent': userAgent };
            }

            const errorDisplay = document.getElementById('error-display');
            errorDisplay.style.display = 'none'; // Hide previous errors

            try {
                const response = await fetch(url, fetchOptions);

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const rawData = await response.json();
                const processedData = processSECData(rawData);
                updateUI(processedData);

            } catch (error) {
                console.error('Failed to fetch or process data:', error);
                errorDisplay.textContent = `Error loading data for CIK ${cik}: ${error.message}. Please check the CIK or try again later.`;
                errorDisplay.style.display = 'block';
                // Update UI with error/N/A values
                updateUI({
                    entityName: `Data for CIK ${cik} (Error)`,
                    max: { val: 'N/A', fy: 'N/A' },
                    min: { val: 'N/A', fy: 'N/A' }
                });
            }
        }

        /**
         * Processes the raw SEC API response to find the max and min shares outstanding.
         * Filters data for fiscal years greater than 2020 and valid numeric values.
         *
         * @param {object} secData - The raw JSON data from the SEC API.
         * @returns {object} An object containing entity name, max and min share values with their fiscal years.
         */
        function processSECData(secData) {
            const entityName = secData.entityName || 'Unknown Entity';
            const shares = secData.units?.shares || [];

            let maxVal = -Infinity;
            let minVal = Infinity;
            let maxFy = 'N/A';
            let minFy = 'N/A';
            let foundValidData = false;

            for (const item of shares) {
                // Ensure 'fy' is a string representing a year and 'val' is a number
                if (item.fy && parseInt(item.fy) > 2020 && typeof item.val === 'number') {
                    foundValidData = true;
                    if (item.val > maxVal) {
                        maxVal = item.val;
                        maxFy = item.fy;
                    }
                    if (item.val < minVal) {
                        minVal = item.val;
                        minFy = item.fy;
                    }
                }
            }

            // If no data matched the criteria, set appropriate messages.
            if (!foundValidData) {
                maxVal = 'No data > 2020';
                minVal = 'No data > 2020';
                maxFy = 'N/A';
                minFy = 'N/A';
            } else if (maxVal === -Infinity) { // This case handles scenarios where somehow foundValidData is true but values are not updated (e.g., malformed data)
                maxVal = 'N/A';
                minVal = 'N/A';
            }

            return {
                entityName: entityName,
                max: { val: maxVal, fy: maxFy },
                min: { val: minVal, fy: minFy }
            };
        }

        /**
         * Updates the HTML elements with the provided processed data.
         *
         * @param {object} data - Processed share volume data.
         */
        function updateUI(data) {
            document.title = `Share Volume for ${data.entityName}`;
            document.getElementById('share-entity-name').textContent = data.entityName;
            
            // Format numbers with commas for better readability
            document.getElementById('share-max-value').textContent = typeof data.max.val === 'number' ? data.max.val.toLocaleString() : data.max.val;
            document.getElementById('share-max-fy').textContent = data.max.fy;
            
            document.getElementById('share-min-value').textContent = typeof data.min.val === 'number' ? data.min.val.toLocaleString() : data.min.val;
            document.getElementById('share-min-fy').textContent = data.min.fy;
        }

        // Main execution logic:
        // On page load, check for a CIK in the URL query parameters.
        // If present, use that CIK; otherwise, use the default AES Corporation CIK.
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const cik = urlParams.get('CIK');
            const defaultCik = '0000874761'; // AES Corporation CIK

            fetchAndDisplayData(cik || defaultCik);
        });
    </script>
    <!-- Bootstrap JS from CDN (for future interactive components, not strictly needed for this basic app) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
</body>
</html>